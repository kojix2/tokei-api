<div class="row">
  <div class="col-md-10 offset-md-1">
    <div class="card">
      <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="mb-0">解析結果: <%= analysis.repo_url %></h2>
          <small><%= analysis.analyzed_at.not_nil!.to_s("%Y-%m-%d %H:%M") %></small>
        </div>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">
                <h4>言語別コード行数</h4>
              </div>
              <div class="card-body">
                <canvas id="languageChart" width="400" height="300"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">
                <h4>コード・コメント・空行の比率</h4>
              </div>
              <div class="card-body">
                <canvas id="codeTypeChart" width="400" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table id="language-stats-table" class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th class="sortable" data-sort="string">言語 <span class="sort-icon">↕</span></th>
                <th class="sortable" data-sort="number">ファイル数 <span class="sort-icon">↕</span></th>
                <th class="sortable" data-sort="number">コード行 <span class="sort-icon">↕</span></th>
                <th class="sortable" data-sort="number">コメント行 <span class="sort-icon">↕</span></th>
                <th class="sortable" data-sort="number">空行 <span class="sort-icon">↕</span></th>
                <th class="sortable" data-sort="number">合計 <span class="sort-icon">↕</span></th>
              </tr>
            </thead>
            <tbody>
              <% total_files = 0 %>
              <% total_code = 0 %>
              <% total_comments = 0 %>
              <% total_blanks = 0 %>
              
              <% result_json.as_h.each do |language, stats| %>
                <% next if language == "Total" %>
                <% stats_obj = stats.as_h %>
                <% files = stats_obj["reports"]?.try(&.as_a.size) || stats_obj["files"]?.try(&.as_i) || 0 %>
                <% code = stats_obj["code"]?.try(&.as_i) || 0 %>
                <% comments = stats_obj["comments"]?.try(&.as_i) || 0 %>
                <% blanks = stats_obj["blanks"]?.try(&.as_i) || 0 %>
                
                <% total_files += files %>
                <% total_code += code %>
                <% total_comments += comments %>
                <% total_blanks += blanks %>
                
                <tr>
                  <td><strong><%= language %></strong></td>
                  <td><%= files %></td>
                  <td><%= code %></td>
                  <td><%= comments %></td>
                  <td><%= blanks %></td>
                  <td><%= code + comments + blanks %></td>
                </tr>
              <% end %>
            </tbody>
            <tfoot class="table-dark">
              <tr>
                <th>合計</th>
                <th><%= total_files %></th>
                <th><%= total_code %></th>
                <th><%= total_comments %></th>
                <th><%= total_blanks %></th>
                <th><%= total_code + total_comments + total_blanks %></th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="mt-4">
          <a href="/" class="btn btn-primary">トップページに戻る</a>
          <a href="/api/analysis/<%= analysis.id %>" class="btn btn-info" target="_blank">JSON形式で表示</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 言語別コード行数のグラフ
  const languageData = {};
  const resultJson = <%= analysis.result.to_json %>;
  
  // データの準備
  Object.entries(resultJson).forEach(([language, stats]) => {
    if (language !== 'Total') {
      languageData[language] = stats.code || 0;
    }
  });
  
  // 上位10言語を抽出（コード行数順）
  const topLanguages = Object.entries(languageData)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  
  // 言語名と行数を分離
  const languageNames = topLanguages.map(item => item[0]);
  const codeCounts = topLanguages.map(item => item[1]);
  
  // ランダムな色を生成
  const generateColors = (count) => {
    const colors = [];
    for (let i = 0; i < count; i++) {
      const hue = (i * 360 / count) % 360;
      colors.push(`hsl(${hue}, 70%, 60%)`);
    }
    return colors;
  };
  
  // 言語別グラフ
  const languageCtx = document.getElementById('languageChart').getContext('2d');
  new Chart(languageCtx, {
    type: 'bar',
    data: {
      labels: languageNames,
      datasets: [{
        label: 'コード行数',
        data: codeCounts,
        backgroundColor: generateColors(languageNames.length),
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      scales: {
        x: {
          beginAtZero: true
        }
      }
    }
  });
  
  // コード・コメント・空行の比率グラフ
  let totalCode = 0;
  let totalComments = 0;
  let totalBlanks = 0;
  
  Object.values(resultJson).forEach(stats => {
    if (typeof stats === 'object') {
      totalCode += stats.code || 0;
      totalComments += stats.comments || 0;
      totalBlanks += stats.blanks || 0;
    }
  });
  
  const codeTypeCtx = document.getElementById('codeTypeChart').getContext('2d');
  new Chart(codeTypeCtx, {
    type: 'pie',
    data: {
      labels: ['コード', 'コメント', '空行'],
      datasets: [{
        data: [totalCode, totalComments, totalBlanks],
        backgroundColor: ['#4CAF50', '#2196F3', '#FFC107'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true
    }
  });
});
</script>
